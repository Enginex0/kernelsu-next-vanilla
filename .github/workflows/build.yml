name: Build KernelSU-Next GKI + SUSFS

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: "Android Version"
        type: choice
        options: [android12, android13, android14, android15, android16]
        default: android12
      kernel_version:
        description: "Kernel Version"
        type: choice
        options: ["5.10", "5.15", "6.1", "6.6", "6.12"]
        default: "5.10"
      sub_level:
        description: "Sub Level"
        type: string
        default: "209"
      os_patch_level:
        description: "OS Patch Level (YYYY-MM)"
        type: string
        default: "2024-05"
      device_codename:
        description: "Device Codename (for stock kernel spoofing)"
        type: string
        default: "lake"

jobs:
  build:
    name: "KSU-Next-SUSFS ${{ inputs.kernel_version }}.${{ inputs.sub_level }}"
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Resolve Build Parameters from Device Profile
      run: |
        DEVICE="${{ inputs.device_codename }}"
        PROFILE="device-profiles.json"

        # Start with input values as defaults
        ANDROID_VERSION="${{ inputs.android_version }}"
        KERNEL_VERSION="${{ inputs.kernel_version }}"
        SUB_LEVEL="${{ inputs.sub_level }}"
        OS_PATCH_LEVEL="${{ inputs.os_patch_level }}"

        # Override from profile if device exists
        if [ -f "$PROFILE" ] && command -v jq &> /dev/null; then
          if jq -e ".devices.${DEVICE}" "$PROFILE" > /dev/null 2>&1; then
            echo "=== Auto-filling from device profile: $DEVICE ==="
            ANDROID_VERSION=$(jq -r ".devices.${DEVICE}.android_version" "$PROFILE")
            KERNEL_VERSION=$(jq -r ".devices.${DEVICE}.kernel_version" "$PROFILE")
            SUB_LEVEL=$(jq -r ".devices.${DEVICE}.sub_level" "$PROFILE")
            OS_PATCH_LEVEL=$(jq -r ".devices.${DEVICE}.os_patch_level" "$PROFILE")
            echo "  android_version: $ANDROID_VERSION"
            echo "  kernel_version: $KERNEL_VERSION"
            echo "  sub_level: $SUB_LEVEL"
            echo "  os_patch_level: $OS_PATCH_LEVEL"
          else
            echo "Device '$DEVICE' not in profile, using manual inputs"
          fi
        else
          echo "No profile or jq not available, using manual inputs"
        fi

        # Export to environment for subsequent steps
        echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
        echo "SUB_LEVEL=$SUB_LEVEL" >> $GITHUB_ENV
        echo "OS_PATCH_LEVEL=$OS_PATCH_LEVEL" >> $GITHUB_ENV
        echo "DEVICE_CODENAME=$DEVICE" >> $GITHUB_ENV

    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
        remove_packages_one_command: true
        remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
        rm_cmd: "rmz"
        rmz_version: "3.1.1"
        testing: false

    - name: Setup Build Environment
      run: |
        CONFIG="${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ env.SUB_LEVEL }}"
        KERNEL_ROOT="$GITHUB_WORKSPACE/$CONFIG"
        mkdir -p "$KERNEL_ROOT"

        cat >> $GITHUB_ENV << EOF
        DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig
        CONFIG=$CONFIG
        KERNEL_ROOT=$KERNEL_ROOT
        ANYKERNEL3=$GITHUB_WORKSPACE/AnyKernel3
        SUSFS4KSU=$GITHUB_WORKSPACE/susfs4ksu
        KERNEL_PATCHES=$GITHUB_WORKSPACE/kernel_patches
        REPO=$GITHUB_WORKSPACE/git-repo/repo
        EOF

        mkdir -p "$GITHUB_WORKSPACE/git-repo"
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o "$GITHUB_WORKSPACE/git-repo/repo"
        chmod 0755 "$GITHUB_WORKSPACE/git-repo/repo"
        echo "$GITHUB_WORKSPACE/git-repo" >> "$GITHUB_PATH"

    - name: Clone Dependencies
      run: |
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
        rm -rf AnyKernel3/.git
        git clone https://github.com/ShirkNeko/SukiSU_patch.git
        git clone https://github.com/WildKernels/kernel_patches.git

    - name: Initialize and Sync Kernel Source
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        FORMATTED_BRANCH="${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ env.OS_PATCH_LEVEL }}"

        repo init -u https://android.googlesource.com/kernel/manifest -b common-${FORMATTED_BRANCH} --repo-rev=v2.16 --depth=1

        REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common ${FORMATTED_BRANCH})
        DEFAULT_MANIFEST_PATH=.repo/manifests/default.xml
        if grep -q deprecated <<< $REMOTE_BRANCH; then
          sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" $DEFAULT_MANIFEST_PATH
        fi

        repo --trace sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

    - name: Extract Sublevel
      run: |
        ACTUAL_SUBLEVEL="${{ env.SUB_LEVEL }}"
        if [[ -f "$KERNEL_ROOT/common/Makefile" ]]; then
          EXTRACTED=$(grep '^SUBLEVEL = ' "$KERNEL_ROOT/common/Makefile" | awk '{print $3}')
          [[ -n "$EXTRACTED" ]] && ACTUAL_SUBLEVEL="$EXTRACTED"
        fi

        ARTIFACT_BASE="${{ env.KERNEL_VERSION }}.$ACTUAL_SUBLEVEL-${{ env.ANDROID_VERSION }}-${{ env.OS_PATCH_LEVEL }}-KSU-Next-SUSFS"
        echo "ACTUAL_SUBLEVEL=$ACTUAL_SUBLEVEL" >> $GITHUB_ENV
        echo "ARTIFACT_BASE=$ARTIFACT_BASE" >> $GITHUB_ENV
        echo "FILE_NAME=$ARTIFACT_BASE" >> $GITHUB_ENV

    - name: Apply glibc 2.38 Compatibility Fix
      run: |
        if [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] ||
           [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] ||
           [[ "${{ env.ANDROID_VERSION }}" == "android14" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]] ||
           [[ "${{ env.ANDROID_VERSION }}" == "android14" && "${{ env.KERNEL_VERSION }}" == "6.1" && $ACTUAL_SUBLEVEL -le 43 ]]; then
          GLIBC_VERSION=$(ldd --version 2>/dev/null | head -n 1 | awk '{print $NF}')
          if [ "$(printf '%s\n' "2.38" "$GLIBC_VERSION" | sort -V | head -n1)" = "2.38" ]; then
            cd "$KERNEL_ROOT/common"
            sed -i '/\$(Q)\$(MAKE) -C \$(SUBCMD_SRC) OUTPUT=\$(abspath \$(dir \$@))\/ \$(abspath \$@)/s//$(Q)$(MAKE) -C $(SUBCMD_SRC) EXTRA_CFLAGS="$(CFLAGS)" OUTPUT=$(abspath $(dir $@))\/ $(abspath $@)/' tools/bpf/resolve_btfids/Makefile 2>/dev/null || true
            if [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.10" && $ACTUAL_SUBLEVEL -le 186 ]] ||
               [[ "${{ env.ANDROID_VERSION }}" == "android13" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 119 ]] ||
               [[ "${{ env.ANDROID_VERSION }}" == "android14" && "${{ env.KERNEL_VERSION }}" == "5.15" && $ACTUAL_SUBLEVEL -le 110 ]]; then
              sed -i '/char \*buf = NULL;/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++) {/for (i = 0; subcommands[i]; i++) {/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i '/if (subcommands) {/a int i;' tools/lib/subcmd/parse-options.c 2>/dev/null || true
              sed -i 's/for (int i = 0; subcommands\[i\]; i++)/for (i = 0; subcommands[i]; i++)/' tools/lib/subcmd/parse-options.c 2>/dev/null || true
            fi
          fi
        fi

    - name: Add KernelSU-Next with SUSFS
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding KernelSU-Next (dev_susfs branch) ==="
        curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/dev_susfs/kernel/setup.sh" | bash -s dev_susfs
        echo "=== KernelSU-Next added ==="

    - name: Fix KernelSU-Next API Compatibility
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        KSUD_FILE="$KERNEL_ROOT/KernelSU-Next/kernel/ksud.c"
        if [ -f "$KSUD_FILE" ] && ! grep -q "ksu_handle_sys_newfstatat" "$KSUD_FILE"; then
          awk '/void ksu_handle_vfs_fstat/{found=1} found && /^}/{print; print "void ksu_handle_sys_newfstatat(int fd, loff_t *kstat_size_ptr) { }"; found=0; next}1' "$KSUD_FILE" > "$KSUD_FILE.tmp" && mv "$KSUD_FILE.tmp" "$KSUD_FILE"
          echo "[+] ksu_handle_sys_newfstatat stub added to ksud.c"
        fi

    - name: Clone Upstream SUSFS and Inject Custom Features
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        SUSFS_BRANCH="gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-dev"
        echo "=== Cloning upstream SUSFS (branch: $SUSFS_BRANCH) ==="
        git clone --depth 1 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" "$SUSFS4KSU"

        SUSFS_PATCHES="$SUSFS4KSU/kernel_patches"
        INJECT_DIR="$GITHUB_WORKSPACE/scripts/susfs"
        chmod +x "$INJECT_DIR"/*.sh

        echo "=== Injecting custom features into upstream SUSFS ==="
        bash "$INJECT_DIR/fix-susfs-safety.sh" "$SUSFS_PATCHES"
        bash "$INJECT_DIR/inject-susfs-kstat-redirect.sh" "$SUSFS_PATCHES"
        bash "$INJECT_DIR/inject-susfs-open-redirect-all.sh" "$SUSFS_PATCHES"
        bash "$INJECT_DIR/inject-susfs-unicode-filter-func.sh" "$SUSFS_PATCHES"
        bash "$INJECT_DIR/inject-susfs-supercall-dispatch.sh" "$SUSFS_PATCHES"
        bash "$INJECT_DIR/inject-susfs-zeromount-coupling.sh" "$SUSFS_PATCHES"

        echo "=== Applying modified SUSFS to kernel ==="
        cd "$KERNEL_ROOT/common"

        cp "$SUSFS_PATCHES/fs/susfs.c" ./fs/
        cp "$SUSFS_PATCHES/include/linux/"*.h ./include/linux/

        SUSFS_PATCH="$SUSFS_PATCHES/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch"
        if [ -f "$SUSFS_PATCH" ]; then
          patch -p1 --no-backup-if-mismatch < "$SUSFS_PATCH"
        else
          echo "ERROR: SUSFS patch not found: $SUSFS_PATCH" && exit 1
        fi

        echo "=== Post-patch: injecting into kernel source ==="
        bash "$INJECT_DIR/inject-susfs-vfs-open-redirect-all.sh" "$KERNEL_ROOT/common"
        bash "$INJECT_DIR/inject-susfs-mount-display.sh" "$KERNEL_ROOT/common"

        echo "=== Injecting custom handlers into KernelSU-Next ==="
        bash "$INJECT_DIR/inject-susfs-custom-handlers.sh" \
          "$KERNEL_ROOT/KernelSU-Next/kernel/supercalls.c" \
          "$KERNEL_ROOT/common/fs/susfs.c" \
          "$KERNEL_ROOT/KernelSU-Next/kernel/Kconfig" \
          "${{ env.DEFCONFIG }}"

        echo "=== Injecting unicode filter VFS hooks ==="
        bash "$GITHUB_WORKSPACE/scripts/susfs/unicode_filter.sh" "$KERNEL_ROOT/common"

        if [[ "${{ env.ANDROID_VERSION }}" == "android12" && "${{ env.KERNEL_VERSION }}" == "5.10" ]]; then
          if [[ "$ACTUAL_SUBLEVEL" -le 209 ]]; then
            sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
          fi
        fi

        echo "=== SUSFS integration complete ==="

    - name: Fix sucompat stat hook detection bypass
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Fixing sucompat stat hook (missing umounted check) ==="
        # The execveat and faccessat hooks have susfs_is_current_proc_umounted() check
        # but ksu_handle_stat is missing it, causing detection apps to see su->sh transformation
        SUCOMPAT="$KERNEL_ROOT/KernelSU-Next/kernel/sucompat.c"
        if [ ! -f "$SUCOMPAT" ]; then
          echo "[-] sucompat.c not found, skipping"
          exit 0
        fi

        # Check if ksu_handle_stat SPECIFICALLY has the umounted check (not other functions)
        # Extract ksu_handle_stat function and check for the pattern
        STAT_HAS_CHECK=$(awk '/^int ksu_handle_stat/{found=1} found && /susfs_is_current_proc_umounted/{print "yes"; exit} found && /^int [a-z]/{exit}' "$SUCOMPAT")

        if [ "$STAT_HAS_CHECK" = "yes" ]; then
          echo "[*] ksu_handle_stat already has umounted check"
        else
          echo "[+] Patching ksu_handle_stat in $SUCOMPAT"
          # Insert check after the first "return 0;" in ksu_handle_stat (after ksu_is_allow_uid check)
          awk '
          /^int ksu_handle_stat/ { in_stat = 1; first_return_done = 0 }
          in_stat && /return 0;/ && !first_return_done {
            print
            first_return_done = 1
            getline
            if (/^[[:space:]]*}/) {
              print
              getline
              # Insert after the closing brace of the first if block
              print ""
              print "#ifdef CONFIG_KSU_SUSFS"
              print "\tif (susfs_is_current_proc_umounted()) {"
              print "\t\treturn 0;"
              print "\t}"
              print "#endif"
            }
            print
            next
          }
          /^int [a-z]/ && !/^int ksu_handle_stat/ { in_stat = 0 }
          { print }
          ' "$SUCOMPAT" > "${SUCOMPAT}.tmp" && mv "${SUCOMPAT}.tmp" "$SUCOMPAT"

          # Verify
          STAT_HAS_CHECK=$(awk '/^int ksu_handle_stat/{found=1} found && /susfs_is_current_proc_umounted/{print "yes"; exit} found && /^int [a-z]/{exit}' "$SUCOMPAT")
          if [ "$STAT_HAS_CHECK" = "yes" ]; then
            echo "[+] sucompat stat hook fix applied successfully"
          else
            echo "[-] Warning: Fix may not have been applied, trying alternative method"
            # Alternative: insert after ksu_is_allow_uid check using awk
            awk '
            /^int ksu_handle_stat/ { in_stat = 1 }
            in_stat && /if \(!ksu_is_allow_uid_for_current/ { in_uid_check = 1 }
            in_stat && in_uid_check && /^[[:space:]]*\}$/ {
              print
              print ""
              print "#ifdef CONFIG_KSU_SUSFS"
              print "\tif (susfs_is_current_proc_umounted()) {"
              print "\t\treturn 0;"
              print "\t}"
              print "#endif"
              in_uid_check = 0
              next
            }
            /^int [a-z]/ && !/^int ksu_handle_stat/ { in_stat = 0 }
            { print }
            ' "$SUCOMPAT" > "${SUCOMPAT}.tmp2" && mv "${SUCOMPAT}.tmp2" "$SUCOMPAT"

            STAT_HAS_CHECK=$(awk '/^int ksu_handle_stat/{found=1} found && /susfs_is_current_proc_umounted/{print "yes"; exit} found && /^int [a-z]/{exit}' "$SUCOMPAT")
            [ "$STAT_HAS_CHECK" = "yes" ] && echo "[+] Alternative method succeeded" || echo "[-] Both methods failed"
            echo "Final ksu_handle_stat:"
            awk '/^int ksu_handle_stat/{found=1; print; next} found{print} found && /^}$/{exit}' "$SUCOMPAT" | head -35
          fi
        fi
        echo "=== sucompat stat hook fix complete ==="

    - name: Pre-flight ZeroMount script validation
      run: |
        set -euo pipefail

        ZEROMOUNT_DIR="$GITHUB_WORKSPACE/scripts/zeromount"

        echo "=== ZeroMount pre-flight checks ==="

        for f in inject-zeromount-core.sh inject-zeromount-stat.sh inject-zeromount-namei.sh \
                 inject-zeromount-readdir.sh inject-zeromount-dpath.sh inject-zeromount-statfs.sh \
                 inject-zeromount-xattr.sh zeromount-common.sh fix-zeromount-susfs-bypass.sh; do
          [[ -f "$ZEROMOUNT_DIR/$f" ]] || { echo "FAIL: missing $f"; exit 1; }
          bash -n "$ZEROMOUNT_DIR/$f" || { echo "FAIL: syntax error in $f"; exit 1; }
        done

        for f in zeromount.c zeromount.h; do
          [[ -f "$ZEROMOUNT_DIR/src/$f" ]] || { echo "FAIL: missing src/$f"; exit 1; }
        done

        echo "SUCCESS: All ZeroMount files present and syntax-valid"

    - name: Integrate ZeroMount VFS Path Redirection
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        set -euo pipefail

        echo "=== Integrating ZeroMount ==="
        ZEROMOUNT_DIR="$GITHUB_WORKSPACE/scripts/zeromount"

        cd common

        echo "=== Injecting ZeroMount core (Kconfig + Makefile + source files) ==="
        chmod +x "$ZEROMOUNT_DIR/inject-zeromount-core.sh"
        "$ZEROMOUNT_DIR/inject-zeromount-core.sh" .

        [[ -f "fs/zeromount.c" ]] || { echo "FAIL: zeromount.c missing"; exit 1; }
        [[ -f "include/linux/zeromount.h" ]] || { echo "FAIL: zeromount.h missing"; exit 1; }
        grep -q "config ZEROMOUNT" fs/Kconfig || { echo "FAIL: Kconfig not patched"; exit 1; }
        grep -q "zeromount.o" fs/Makefile || { echo "FAIL: Makefile not patched"; exit 1; }
        echo "SUCCESS: ZeroMount core files installed"

        echo "=== Running ZeroMount injection scripts ==="
        chmod +x "$ZEROMOUNT_DIR/inject-zeromount-"*.sh
        chmod +x "$ZEROMOUNT_DIR/zeromount-common.sh"

        "$ZEROMOUNT_DIR/inject-zeromount-stat.sh" fs/stat.c
        echo "  [1/6] stat.c ✓"

        "$ZEROMOUNT_DIR/inject-zeromount-namei.sh" fs/namei.c
        echo "  [2/6] namei.c ✓"

        "$ZEROMOUNT_DIR/inject-zeromount-readdir.sh" fs/readdir.c
        echo "  [3/6] readdir.c ✓"

        "$ZEROMOUNT_DIR/inject-zeromount-dpath.sh" fs/d_path.c
        echo "  [4/6] d_path.c ✓"

        "$ZEROMOUNT_DIR/inject-zeromount-statfs.sh" fs/statfs.c
        echo "  [5/6] statfs.c ✓"

        "$ZEROMOUNT_DIR/inject-zeromount-xattr.sh" fs/xattr.c
        echo "  [6/6] xattr.c ✓"

        echo "=== All 6 ZeroMount hooks injected ==="

        echo "CONFIG_ZEROMOUNT=y" >> arch/arm64/configs/gki_defconfig

        echo "=== Validating ZeroMount hooks ==="
        grep -q "zeromount_stat_hook" fs/stat.c || { echo "FAIL: stat.c hook missing"; exit 1; }
        grep -q "zeromount_getname_hook" fs/namei.c || { echo "FAIL: namei.c hook missing"; exit 1; }
        grep -q "zeromount_inject_dents64" fs/readdir.c || { echo "FAIL: readdir.c hook missing"; exit 1; }
        grep -q "zeromount_get_virtual_path_for_inode" fs/d_path.c || { echo "FAIL: d_path.c hook missing"; exit 1; }
        grep -q "zeromount_spoof_statfs" fs/statfs.c || { echo "FAIL: statfs.c hook missing"; exit 1; }
        grep -q "zeromount_spoof_xattr" fs/xattr.c || { echo "FAIL: xattr.c hook missing"; exit 1; }
        echo "SUCCESS: All ZeroMount hooks validated"

        echo "=== ZeroMount integration complete ==="

    - name: Validate ZeroMount SUSFS detection bypass
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        set -euo pipefail
        chmod +x "$GITHUB_WORKSPACE/scripts/zeromount/fix-zeromount-susfs-bypass.sh"
        "$GITHUB_WORKSPACE/scripts/zeromount/fix-zeromount-susfs-bypass.sh" fs/zeromount.c

    - name: Post-injection ZeroMount C syntax validation
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        set -euo pipefail

        echo "=== ZeroMount post-injection validation ==="
        FAIL=0

        for f in fs/stat.c fs/namei.c fs/readdir.c fs/d_path.c fs/statfs.c fs/xattr.c fs/zeromount.c; do
          OPENS=$(grep -c '#if' "$f" || true)
          CLOSES=$(grep -c '#endif' "$f" || true)
          if [[ "$OPENS" -ne "$CLOSES" ]]; then
            echo "FAIL: $f has unbalanced #if/#endif ($OPENS opens, $CLOSES closes)"
            FAIL=1
          fi

          BRACES_OPEN=$(tr -cd '{' < "$f" | wc -c)
          BRACES_CLOSE=$(tr -cd '}' < "$f" | wc -c)
          if [[ "$BRACES_OPEN" -ne "$BRACES_CLOSE" ]]; then
            echo "FAIL: $f has unbalanced braces ($BRACES_OPEN open, $BRACES_CLOSE close)"
            FAIL=1
          fi
        done

        if [[ "$FAIL" -ne 0 ]]; then
          echo "WARNING: Post-injection heuristic check found imbalances (may be false positive from SUSFS+ZeroMount+unicode_filter overlapping in same files)"
          echo "Proceeding — the compiler is the real validator"
        else
          echo "SUCCESS: All injected files have balanced #if/#endif and braces"
        fi

    - name: Upgrade LZ4 to v1.10.0 with ARM64 NEON
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Upgrading LZ4 to v1.10.0 ==="
        ZRAM_DIR="$GITHUB_WORKSPACE/zram"

        if [ -d "$ZRAM_DIR" ]; then
          # Remove old LZ4 library files
          rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c

          # Copy new LZ4 v1.10.0 library with ARM64 NEON optimization
          cp -r "$ZRAM_DIR/lz4/"* ./lib/lz4/ 2>/dev/null || true
          cp -r "$ZRAM_DIR/include/linux/"* ./include/linux/ 2>/dev/null || true

          # Apply LZ4 kernel integration patch
          if [ -f "$ZRAM_DIR/${{ env.KERNEL_VERSION }}/lz4_1.10.0.patch" ]; then
            patch -p1 -F3 < "$ZRAM_DIR/${{ env.KERNEL_VERSION }}/lz4_1.10.0.patch" || echo "LZ4 v1.10.0 patch skipped"
          fi

          # Verify LZ4 NEON assembly
          if [ -f "lib/lz4/lz4armv8/lz4armv8.S" ]; then
            echo "SUCCESS: LZ4 ARM64 NEON assembly present"
          fi
        else
          echo "Note: zram directory not found, skipping LZ4 v1.10.0 upgrade"
        fi
        echo "=== LZ4 upgrade done ==="

    - name: Add LZ4K/LZ4KD Compression
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        SUKISU="$GITHUB_WORKSPACE/SukiSU_patch"
        KERNEL_VER="${{ env.KERNEL_VERSION }}"

        # Copy LZ4K source files
        cp -r "$SUKISU/other/zram/lz4k/include/linux/"* ./include/linux/
        cp -r "$SUKISU/other/zram/lz4k/lib/"* ./lib/
        cp -r "$SUKISU/other/zram/lz4k/crypto/"* ./crypto/
        cp -r "$SUKISU/other/zram/lz4k_oplus" ./lib/

        # Apply kernel patches (lz4kd required, lz4k_oplus optional)
        if [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch" ]; then
          patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4kd.patch"
        fi
        if [ -f "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" ]; then
          patch -p1 -F3 < "$SUKISU/other/zram/zram_patch/$KERNEL_VER/lz4k_oplus.patch" || echo "Note: lz4k_oplus patch skipped (optional)"
        fi

    - name: Configure Kernel (All 11 SUSFS Features)
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        cat >> "${{ env.DEFCONFIG }}" << 'DEFEOF'
        CONFIG_KSU=y
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_UNICODE_FILTER=y
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        CONFIG_ZSMALLOC=m
        CONFIG_ZRAM=m
        CONFIG_ZRAM_WRITEBACK=y
        CONFIG_CRYPTO_LZ4=y
        CONFIG_CRYPTO_LZ4HC=y
        CONFIG_CRYPTO_LZ4K=y
        CONFIG_CRYPTO_LZ4KD=y
        CONFIG_CRYPTO_842=y
        CONFIG_CRYPTO_LZ4K_OPLUS=y
        CONFIG_ZRAM_DEF_COMP_LZ4KD=y
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_TCP_CONG_CUBIC=y
        CONFIG_TCP_CONG_BIC=n
        CONFIG_TCP_CONG_WESTWOOD=y
        CONFIG_TCP_CONG_HTCP=y
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534
        CONFIG_IP_SET_BITMAP_IP=y
        CONFIG_IP_SET_BITMAP_IPMAC=y
        CONFIG_IP_SET_BITMAP_PORT=y
        CONFIG_IP_SET_HASH_IP=y
        CONFIG_IP_SET_HASH_IPMARK=y
        CONFIG_IP_SET_HASH_IPPORT=y
        CONFIG_IP_SET_HASH_IPPORTIP=y
        CONFIG_IP_SET_HASH_IPPORTNET=y
        CONFIG_IP_SET_HASH_IPMAC=y
        CONFIG_IP_SET_HASH_MAC=y
        CONFIG_IP_SET_HASH_NETPORTNET=y
        CONFIG_IP_SET_HASH_NET=y
        CONFIG_IP_SET_HASH_NETNET=y
        CONFIG_IP_SET_HASH_NETPORT=y
        CONFIG_IP_SET_HASH_NETIFACE=y
        CONFIG_IP_SET_LIST_SET=y
        DEFEOF
        sed -i 's/^        //' "${{ env.DEFCONFIG }}"
        # ZRAM/ZSMALLOC must stay =m to match gki_aarch64_modules list

        # Disable defconfig check for build
        if [[ "${{ env.KERNEL_VERSION }}" == "6.12" ]]; then
          sed -i '/name = "kernel_aarch64",/a\    check_defconfig = "disabled",' common/BUILD.bazel
        else
          sed -i 's/check_defconfig//' ./common/build.config.gki
        fi

    - name: Apply Performance Patches
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Applying Performance Patches ==="
        MIN_VERSION="5.16"

        cp "$KERNEL_PATCHES/common/optimized_mem_operations.patch" ./
        patch -p1 --forward < optimized_mem_operations.patch || echo "optimized_mem_operations skipped"

        cp "$KERNEL_PATCHES/common/file_struct_8bytes_align.patch" ./
        patch -p1 --forward < file_struct_8bytes_align.patch || echo "file_struct_8bytes_align skipped"

        cp "$KERNEL_PATCHES/common/reduce_cache_pressure.patch" ./
        patch -p1 --forward < reduce_cache_pressure.patch || echo "reduce_cache_pressure skipped"

        if [[ "$(printf '%s\n' "${{ env.KERNEL_VERSION }}" "$MIN_VERSION" | sort -V | head -n1)" = "${{ env.KERNEL_VERSION }}" ]]; then
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          patch -p1 --forward < clear_page_16bytes_align.patch || echo "clear_page_16bytes_align skipped"
        else
          cp "$KERNEL_PATCHES/common/clear_page_16bytes_align.patch" ./
          sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
          patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch || echo "clear_page_16bytes_align__pi skipped"
        fi
        echo "=== Performance Patches Done ==="

    - name: Add BBG (Baseband Guard)
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding BBG ==="
        curl -LSs https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig
        echo "=== BBG Done ==="

    - name: Fix WiFi/BT on Xiaomi 6.6 GKI devices
      if: env.KERNEL_VERSION == '6.6'
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        echo "=== Adding Xiaomi 6.6 WiFi/BT fix ==="
        SYMBOL_LIST=android/abi_gki_aarch64_xiaomi
        if [ -f "$SYMBOL_LIST" ]; then
          echo "device_find_any_child" >> $SYMBOL_LIST
          echo "SUCCESS: Added device_find_any_child to Xiaomi symbol list"
        else
          echo "Note: Xiaomi symbol list not found, skipping"
        fi

    - name: Apply Module Check Bypass
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Applying Module Check Bypass ==="
        if [[ "${{ env.KERNEL_VERSION }}" == "6.1" || "${{ env.KERNEL_VERSION }}" == "6.6" || "${{ env.KERNEL_VERSION }}" == "6.12" ]]; then
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module/version.c"
        else
          TARGET_FILE="$KERNEL_ROOT/common/kernel/module.c"
        fi

        sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"

        if grep -A 5 "bad_version:" "$TARGET_FILE" | grep -q "return 1;"; then
          echo "SUCCESS: Module check bypass applied"
        else
          echo "WARNING: Module check bypass may not have applied"
        fi
        echo "=== Module Check Bypass Done ==="

    - name: Add Android 16/6.12 ashmem Exports
      if: env.ANDROID_VERSION == 'android16' && env.KERNEL_VERSION == '6.12'
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Adding ashmem exports for Android 16 ==="
        FILE=common/drivers/staging/android/ashmem.c
        if [[ -f "$FILE" ]] && ! grep -q 'is_ashmem_file' "$FILE"; then
          cat >>"$FILE" <<'ASHMEM_EOF'
        bool is_ashmem_file(struct file *file) { return false; }
        int ashmem_area_name(struct file *file, char *name) { return 0; }
        long ashmem_area_size(struct file *file) { return 0; }
        struct file *ashmem_area_vmfile(struct file *file) { return NULL; }
        EXPORT_SYMBOL_GPL(is_ashmem_file);
        EXPORT_SYMBOL_GPL(ashmem_area_name);
        EXPORT_SYMBOL_GPL(ashmem_area_size);
        EXPORT_SYMBOL_GPL(ashmem_area_vmfile);
        ASHMEM_EOF
          sed -i 's/^        //' "$FILE"
          echo "SUCCESS: ashmem exports added"
        fi

        # Handle Rust binder configuration
        if [ -f common/drivers/android/binder/Makefile ]; then
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/binder/Makefile
          perl -i -pe 's/^rust_binder-\$\([^)]+\)\s*:=/rust_binder-y :=/' common/drivers/android/binder/Makefile
          rustup set profile minimal
          rustup update nightly
          rustup default nightly
          rustup target add aarch64-unknown-none
        else
          perl -i -0777 -pe 's/\$\(\s*CONFIG_ANDROID_BINDER_IPC_RUST\s*\)/m/' common/drivers/android/Makefile 2>/dev/null || true
        fi
        echo "=== Android 16 ashmem exports done ==="

    - name: Clean Build Flags
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        # Remove dirty flags from version string
        if [ -f "build/build.sh" ]; then
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
        else
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i 's/-dirty//' ./common/scripts/setlocalversion
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
        fi

    - name: Set Stock Build Identity
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        DEVICE_CODENAME="${{ env.DEVICE_CODENAME }}"
        PROFILE_FILE="$GITHUB_WORKSPACE/device-profiles.json"

        if [ -f "$PROFILE_FILE" ] && command -v jq &> /dev/null; then
          DEVICE_EXISTS=$(jq -r ".devices.${DEVICE_CODENAME} // empty" "$PROFILE_FILE")

          if [ -n "$DEVICE_EXISTS" ]; then
            echo "=== Using device profile: $DEVICE_CODENAME ==="

            STOCK_RELEASE=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.release" "$PROFILE_FILE")
            STOCK_VERSION=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.version_string" "$PROFILE_FILE")
            STOCK_BUILD_USER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_user" "$PROFILE_FILE")
            STOCK_BUILD_HOST=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.build_host" "$PROFILE_FILE")
            STOCK_COMPILER=$(jq -r ".devices.${DEVICE_CODENAME}.stock_kernel.compiler_info // empty" "$PROFILE_FILE")

            echo "Stock release: $STOCK_RELEASE"
            echo "Stock version: $STOCK_VERSION"
            [ -n "$STOCK_COMPILER" ] && echo "Stock compiler: $STOCK_COMPILER"

            # Patch setlocalversion to return stock release suffix
            cat > scripts/setlocalversion << 'SETLOCAL_EOF'
        #!/bin/sh
        # Stock kernel identity - patched for detection bypass
        printf '%s' "$STOCK_RELEASE_SUFFIX"
        SETLOCAL_EOF
            sed -i "s|\$STOCK_RELEASE_SUFFIX|${STOCK_RELEASE}|g" scripts/setlocalversion
            chmod +x scripts/setlocalversion

            # Patch mkcompile_h for stock version string and compiler
            if [ -f "scripts/mkcompile_h" ]; then
              sed -i "s|UTS_VERSION=.*|UTS_VERSION=\"${STOCK_VERSION}\"|" scripts/mkcompile_h
              if grep -q "LINUX_COMPILE_BY=" scripts/mkcompile_h; then
                sed -i "s|LINUX_COMPILE_BY=.*|LINUX_COMPILE_BY=\"${STOCK_BUILD_USER}\"|" scripts/mkcompile_h
                sed -i "s|LINUX_COMPILE_HOST=.*|LINUX_COMPILE_HOST=\"${STOCK_BUILD_HOST}\"|" scripts/mkcompile_h
              fi
              # Spoof compiler info in /proc/version
              if [ -n "$STOCK_COMPILER" ] && grep -q "LINUX_COMPILER=" scripts/mkcompile_h; then
                sed -i "s|LINUX_COMPILER=.*|LINUX_COMPILER=\"${STOCK_COMPILER}\"|" scripts/mkcompile_h
              fi
            fi

            echo "KBUILD_BUILD_USER=$STOCK_BUILD_USER" >> $GITHUB_ENV
            echo "KBUILD_BUILD_HOST=$STOCK_BUILD_HOST" >> $GITHUB_ENV
          else
            echo "WARNING: Device $DEVICE_CODENAME not found in profiles, using defaults"
          fi
        else
          echo "WARNING: device-profiles.json not found or jq not available"
        fi

    - name: Commit Changes
      working-directory: ${{ env.KERNEL_ROOT }}/common
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Apply KernelSU-Next + SUSFS + Stock Identity" || true

    - name: Build Kernel
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        if [ -f "build/build.sh" ]; then
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh || exit 1
        else
          tools/bazel build --config=fast --config=stamp --lto=thin //common:kernel_aarch64_dist || exit 1
        fi

    - name: Prepare AnyKernel3 Zip
      run: |
        if [ -f "$KERNEL_ROOT/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist/Image" ]; then
          cp "$KERNEL_ROOT/out/${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}/dist/Image" "$ANYKERNEL3/Image"
        elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
          cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" "$ANYKERNEL3/Image"
        else
          echo "ERROR: Cannot find kernel Image"
          find $KERNEL_ROOT -name "Image" -type f 2>/dev/null || true
          exit 1
        fi

    - name: Create ZRAM Module (Full Version)
      run: |
        echo "=== Creating KSU ZRAM module ==="
        ZRAM_MOD="$ANYKERNEL3/modules/data/adb/modules/zram_config"
        mkdir -p "$ZRAM_MOD/META-INF/com/google/android"

        # Create module.prop
        cat > "$ZRAM_MOD/module.prop" << 'MODPROP'
        id=zram_config
        name=ZRAM 8GB LZ4 Configuration
        version=1.0
        versionCode=1
        author=Enginex0
        description=Configures ZRAM with 8GB size and LZ4 compression at boot. Compatible with Magisk/KernelSU.
        MODPROP
        sed -i 's/^        //' "$ZRAM_MOD/module.prop"

        # Create service.sh with detailed logging
        cat > "$ZRAM_MOD/service.sh" << 'SERVICESH'
        #!/system/bin/sh
        MODDIR=${0%/*}
        LOG="$MODDIR/zram.log"

        log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG"
        }

        ZRAM_SIZE=8589934592
        ZRAM_ALGO=lz4
        MAX_STREAMS=8

        log "========================================="
        log "=== ZRAM Configuration Service Start ==="
        log "========================================="

        log "Waiting for system initialization..."
        sleep 30

        log "Stopping existing ZRAM swap..."
        swapoff /dev/block/zram0 2>/dev/null
        sleep 2

        log "Resetting ZRAM device..."
        echo 1 > /sys/block/zram0/reset 2>/dev/null
        sleep 1

        log "Setting max_comp_streams: $MAX_STREAMS"
        echo "$MAX_STREAMS" > /sys/block/zram0/max_comp_streams 2>/dev/null

        log "Setting compression algorithm: $ZRAM_ALGO"
        echo "$ZRAM_ALGO" > /sys/block/zram0/comp_algorithm 2>/dev/null

        log "Setting disksize: $ZRAM_SIZE bytes (8GB)"
        echo "$ZRAM_SIZE" > /sys/block/zram0/disksize 2>/dev/null

        log "Initializing swap partition..."
        mkswap /dev/block/zram0 > /dev/null 2>&1

        log "Enabling swap..."
        swapon /dev/block/zram0 > /dev/null 2>&1

        ACTUAL_SIZE=$(cat /sys/block/zram0/disksize 2>/dev/null)
        ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null | grep -o '\[.*\]' | tr -d '[]')
        [ -z "$ACTUAL_ALGO" ] && ACTUAL_ALGO=$(cat /sys/block/zram0/comp_algorithm 2>/dev/null)

        log "----------------------------------------"
        log "ZRAM Configuration Result:"
        log "  Size: $ACTUAL_SIZE bytes"
        log "  Algorithm: $ACTUAL_ALGO"
        log "----------------------------------------"

        MEM_INFO=$(free -h 2>/dev/null | grep -E "Mem:|Swap:")
        log "Memory Status:"
        log "$MEM_INFO"

        log "=== ZRAM Configuration Complete ==="
        SERVICESH
        sed -i 's/^        //' "$ZRAM_MOD/service.sh"
        chmod +x "$ZRAM_MOD/service.sh"

        # Create customize.sh
        cat > "$ZRAM_MOD/customize.sh" << 'CUSTOMIZESH'
        #!/system/bin/sh
        ui_print "========================================="
        ui_print "   ZRAM 8GB LZ4 Configuration Module"
        ui_print "   Author: Enginex0"
        ui_print "========================================="
        ui_print ""
        ui_print "Configuration:"
        ui_print "  - ZRAM Size: 8GB"
        ui_print "  - Algorithm: LZ4"
        ui_print "  - Streams: 8"
        ui_print ""
        ui_print "The module will configure ZRAM at boot."
        ui_print ""
        set_perm_recursive $MODPATH 0 0 0755 0644
        set_perm $MODPATH/service.sh 0 0 0755
        CUSTOMIZESH
        sed -i 's/^        //' "$ZRAM_MOD/customize.sh"
        chmod +x "$ZRAM_MOD/customize.sh"

        # Create updater-script
        echo '#MAGISK' > "$ZRAM_MOD/META-INF/com/google/android/updater-script"

        # Create update-binary for full Magisk compatibility
        cat > "$ZRAM_MOD/META-INF/com/google/android/update-binary" << 'UPDATEBIN'
        #!/sbin/sh
        umask 022
        TMPDIR=/dev/tmp
        rm -rf $TMPDIR 2>/dev/null
        mkdir -p $TMPDIR
        ui_print() { echo "$1"; }
        require_new_magisk() {
          ui_print "*******************************"
          ui_print " Please install Magisk v20.4+! "
          ui_print "*******************************"
          exit 1
        }
        OUTFD=$2
        ZIPFILE=$3
        mount /data 2>/dev/null
        [ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
        . /data/adb/magisk/util_functions.sh
        [ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk
        setup_flashable
        mount_partitions
        api_level_arch_detect
        $BOOTMODE && boot_actions || recovery_actions
        unzip -o "$ZIPFILE" module.prop -d $TMPDIR >&2
        [ ! -f $TMPDIR/module.prop ] && abort "! Unable to extract zip file!"
        $BOOTMODE && MODDIRNAME=modules_update || MODDIRNAME=modules
        MODULEROOT=$NVBASE/$MODDIRNAME
        MODID=$(grep_prop id $TMPDIR/module.prop)
        MODPATH=$MODULEROOT/$MODID
        rm -rf $MODPATH 2>/dev/null
        mkdir -p $MODPATH
        ui_print "- Extracting module files"
        unzip -o "$ZIPFILE" -d $MODPATH >&2
        rm -rf $MODPATH/META-INF 2>/dev/null
        set_perm_recursive $MODPATH 0 0 0755 0644
        [ -f $MODPATH/service.sh ] && set_perm $MODPATH/service.sh 0 0 0755
        $BOOTMODE && {
          mktouch $NVBASE/modules/$MODID/update
          cp -af $MODPATH/module.prop $NVBASE/modules/$MODID/module.prop
        }
        [ -f $MODPATH/sepolicy.rule ] && {
          ui_print "- Installing custom sepolicy rules"
          copy_sepolicy_rules
        }
        cd /
        $BOOTMODE || recovery_cleanup
        rm -rf $TMPDIR
        ui_print "- Done"
        exit 0
        UPDATEBIN
        sed -i 's/^        //' "$ZRAM_MOD/META-INF/com/google/android/update-binary"
        chmod +x "$ZRAM_MOD/META-INF/com/google/android/update-binary"

        echo "=== ZRAM module created ==="

    - name: Scan and Collect Patch Rejects
      if: always()
      working-directory: ${{ env.KERNEL_ROOT }}
      run: |
        echo "=== Scanning for patch reject files ==="
        REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
        mkdir -p "$REJECTS_DIR"
        mapfile -t REJS < <(find . -type f -name '*.rej')
        REJ_COUNT=${#REJS[@]}
        echo "Found $REJ_COUNT .rej files"
        echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
        if [ "$REJ_COUNT" -gt 0 ]; then
          for REJ in "${REJS[@]}"; do
            REL="${REJ#./}"
            DEST="$REJECTS_DIR/$REL"
            mkdir -p "$(dirname "$DEST")"
            cp "$REJ" "$DEST"
            ORIG="${REJ%.rej}"
            if [ -f "$ORIG" ]; then
              ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
              mkdir -p "$(dirname "$ORIG_DEST")"
              cp "$ORIG" "$ORIG_DEST"
            fi
          done
          echo "## ⚠️ Patch Rejects Found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          printf '%s\n' "${REJS[@]}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "✓ No patch rejects found"
        fi

    - name: Upload Rejects
      if: always() && env.REJ_COUNT > 0
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-Rejects
        path: patch-rejects/
        if-no-files-found: ignore
        compression-level: 9

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FILE_NAME }}-AnyKernel3
        path: ./AnyKernel3/**
        compression-level: 9

    - name: Build Summary
      run: |
        echo "## KernelSU-Next + SUSFS + ZeroMount Build" >> $GITHUB_STEP_SUMMARY
        echo "| Config | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Kernel | ${{ env.KERNEL_VERSION }}.${{ env.ACTUAL_SUBLEVEL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Android | ${{ env.ANDROID_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| KSU | KernelSU-Next (next branch) |" >> $GITHUB_STEP_SUMMARY
        echo "| SUSFS | upstream + injection scripts |" >> $GITHUB_STEP_SUMMARY
        echo "| ZeroMount | VFS path redirection (v1) |" >> $GITHUB_STEP_SUMMARY
        echo "| ZRAM | LZ4K/LZ4KD 8GB |" >> $GITHUB_STEP_SUMMARY
        echo "| Device Profile | ${{ env.DEVICE_CODENAME }} |" >> $GITHUB_STEP_SUMMARY
